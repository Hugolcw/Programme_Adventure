# 答案09：代码改错 - 多态失效

## 错误分析

### 错误1：缺少virtual关键字
- **位置**：`Animal::speak()` 函数
- **问题**：没有 `virtual` 关键字，无法实现多态
- **后果**：通过基类指针调用时，总是调用基类的版本，而不是派生类的版本

### 错误2：基类析构函数不是虚函数
- **位置**：`Animal` 类缺少虚析构函数
- **问题**：通过基类指针删除派生类对象时，可能只调用基类析构函数
- **后果**：派生类部分可能没有被正确清理（虽然这个例子中派生类没有需要清理的资源）

## 修正后的代码

```cpp
#include <iostream>
using namespace std;

class Animal {
public:
    virtual void speak() {  // 修正：添加virtual关键字
        cout << "Animal speaks" << endl;
    }
    virtual ~Animal() {     // 修正：添加虚析构函数（最佳实践）
        // 可以留空，但声明为virtual很重要
    }
};

class Dog : public Animal {
public:
    void speak() override {  // 可选：添加override关键字（C++11）
        cout << "Dog barks" << endl;
    }
};

class Cat : public Animal {
public:
    void speak() override {  // 可选：添加override关键字
        cout << "Cat meows" << endl;
    }
};

int main() {
    Animal* animals[3];
    animals[0] = new Dog();
    animals[1] = new Cat();
    animals[2] = new Animal();
    
    for (int i = 0; i < 3; i++) {
        animals[i]->speak();
    }
    
    // 清理内存
    for (int i = 0; i < 3; i++) {
        delete animals[i];
    }
    
    return 0;
}
```

## 详细解析

### 修正前 vs 修正后的输出

**修正前（多态失效）**：
```
Animal speaks
Animal speaks
Animal speaks
```
所有调用都执行基类的 `speak()` 函数。

**修正后（多态生效）**：
```
Dog barks
Cat meows
Animal speaks
```
根据实际对象类型调用对应的 `speak()` 函数。

### 虚函数的工作原理

1. **virtual关键字**：
   - 告诉编译器这个函数可以被子类重写
   - 创建虚函数表（vtable）
   - 实现运行时多态

2. **多态的条件**：
   - ✅ 基类指针或引用
   - ✅ 虚函数（virtual关键字）
   - ✅ 派生类重写虚函数

3. **override关键字**（C++11，可选但推荐）：
   - 明确表示重写基类的虚函数
   - 如果基类没有对应的虚函数，编译会报错
   - 提高代码可读性和安全性

### 虚析构函数的重要性

```cpp
virtual ~Animal() { }
```

**为什么需要虚析构函数？**

当通过基类指针删除派生类对象时：
- **有虚析构函数**：先调用派生类析构函数，再调用基类析构函数 ✅
- **无虚析构函数**：可能只调用基类析构函数，派生类部分未清理 ❌

**示例**：
```cpp
class Animal {
    // 如果没有virtual，delete animals[0]可能有问题
};

class Dog : public Animal {
    int* data;  // 假设有动态分配的资源
    ~Dog() { delete data; }  // 如果没有虚析构函数，这个可能不会被调用
};
```

### 常见错误总结

| 错误 | 正确 | 说明 |
|------|------|------|
| `void speak()` | `virtual void speak()` | 需要virtual实现多态 |
| `~Animal()` | `virtual ~Animal()` | 基类析构函数应该是虚函数 |
| 忘记override | 添加override | 提高代码安全性（C++11） |

### 最佳实践

1. **基类中的多态函数**：总是使用 `virtual` 关键字
2. **基类析构函数**：总是声明为 `virtual`
3. **派生类重写**：使用 `override` 关键字（C++11）
4. **纯虚函数**：如果基类不应该被实例化，使用 `= 0`：
   ```cpp
   virtual void speak() = 0;  // 纯虚函数，Animal成为抽象类
   ```

